{% extends 'streetview_base.html' %}

{% block hunts %}

<div class="lightbox" id="hunt">
    <h2>02</h2>
    <h3><span>EXPLORE</span>Street hunts</h3>
    <ul class="content_pod-b">
        {% for hunt in data['hunts'] %}
            <li class="default">
                <a href="#" class="btn_green btn">
                    <span>PLAY</span>
                    <h6>{{ hunt['name'] }}</h6>
                    <div><img src="{{ url_for('static', filename='streetview/images/arrow.svg') }}" alt=""></div>
                </a>
            </li>
        {% endfor %}
    </ul>
</div>

{% endblock %}

{% block game_tray %}
<div class="second_header">
    <div class="item_center">
        <a href="javascript:;" class="nav_next"></a>
        <a href="javascript:;" class="nav_prev"></a>
        <div class="title">
            <span class="a">{{ data.treasure['name'] }}</span>
        </div>
    </div>
    <div class="item_left">
        <div class="title" id="clockdiv">
            <span class="a">Time</span>
            <span class="b" id="timer">0</span>
        </div>
    </div>
    <div class="item_right">
        <div class="title">
            <span class="a">Points</span>
            <span class="b" id="points">0</span>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}

<div class="content_section" >
    <div id="panorama" style="width: 100%; height: 100%;"></div>
    <div class="content_block-one">
        <h2>street<br/>hunt<br/><span>name</span></h2>
        <p>{{ data.treasure['description'] }}</p>
        <img src="{{ url_for('static', filename='streetview/images/egg.png') }}" alt="">
        <div>Look around to find the marker</div>
    </div>
    <div class="content_block-two block_content danger" id="message_block">
        <div class="icon icon_1"></div>
        <div class="icon icon_2"></div>
        <div class="icon icon_3"></div>
        <div class="icon icon_4"></div>
        <div class="wrapper">
            <div class="pod">
                <h2 id="clue_ident">CLUE #1</h2>
                <h3>{{ data.clue['description'] }}</h3>
                {% for opt in data.options %}
                    <a onclick="relocatePlayer( '{{ opt['id'] }}' )">
                        Go to {{ opt['name'] }}
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>

     <div id="form-score" class="content_block-one block_content" style="background-color: #f7f7f7; position: absolute;left: 50%; top: 50%;transform: translate(-50%, -50%);">
         <div class="wrapper">
            <h2>Enter Details</h2>
            <form class="form-control">
                <input type="text" name="name" id="username" placeholder="Enter your name here...">
                <input type="text" name="phone" id="phone" placeholder="Enter your phone number here...">

                <input type="submit" value="submit" class="button">
            </form>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
/***
 * **************************************
 * Store Game letiables
 */
$( document ).ready(function() {
    localStorage.setItem('points', 0);
    localStorage.setItem('treasure_id', '{{ data.treasure['id']|safe }}' );
    localStorage.setItem('clue', 1);
    $('#form-score').hide();

     $('form').submit(function(event) {

        let points = localStorage.getItem('points');
        let time = localStorage.getItem('time');
        let treasure_id = localStorage.getItem('treasure_id');

        let formData = {
            'name'              : $('input[name=name]').val(),
            'phone'             : $('input[name=phone]').val(),
            'points'            : points,
            'treasure_id'       : treasure_id,
            'time'              : time
        };

        $.ajax({
            type        : 'POST',
            url         : "/player/add",
            data        : formData,
            dataType    : 'json',
            encode      : true
        })
            .done(function(data) {
                console.log(data);
            });
        event.preventDefault();
    });

});


/***
 * **************************************
 * Game Time Ticker
 */
let d1 = new Date (),
    d2 = new Date ( d1 );
d2.setMinutes ( d1.getMinutes() + {{ data.treasure['time'] }} );

let countDownDate = d2.getTime();

let x = setInterval(function() {
  let now = new Date().getTime();
  let distance = countDownDate - now;
  let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  let seconds = Math.floor((distance % (1000 * 60)) / 1000);

  $("#timer").html(minutes + "m " + seconds + "s ");

  if (distance < 0) { // time has ended, stop the game!
    clearInterval(x);
    stopGame();
  }
}, 1000);


/***
 * **************************************
 * Google Maps
 */
let panorama;

function initialize() {
  panorama = new google.maps.StreetViewPanorama(
    document.getElementById("panorama"),
    {
      position: { lat: -1.2595552637385474, lng: 36.785125526142544 },
      pov: { heading: 165, pitch: 0 },
      zoom: 1,
      zoomControlOptions: { position: google.maps.ControlPosition.LEFT_CENTER },
      addressControlOptions: { position: google.maps.ControlPosition.BOTTOM_CENTER}
    }
  );

  const gameMarker = new google.maps.Marker({
    position: { lat: 37.86926, lng: -122.254811 },
    map: panorama,
    icon: "https://chart.apis.google.com/chart?chst=d_map_pin_icon&chld=bus|FFFF00",
    title: "You found it",
  });
}

initialize();


/***
 * **************************************
 * Player relocation, to a different scene
 */
const relocatePlayer = (optionId) => {
    // get option details
    let endpoint = "/clue/options/" + optionId;
    let optionsInfo = $.get( endpoint, (data) => {
        if(data.was_endpoint && data.is_correct)
        {
            // the user got the last checkpoint correct, display message
            add_points(data.points);
            $('#message_block').removeClass();
            $('#message_block').addClass("content_block-three success block_content");
            let points = localStorage.getItem('points');
            let timeRemaining = $("#timer").text();
            localStorage.setItem('time', timeRemaining);
            clearInterval(x);
            let html = `
            <div class="icon icon_1"></div>
            <div class="icon icon_2"></div>
            <div class="icon icon_3"></div>
            <div class="icon icon_4"></div>
            <div class="wrapper">
                <div class="pod">
                    <h2>SUCCESS</h2>
                    <p style="font-weight: bold;">{{data.treasure['description']}}</p>
                    <h4><span>${points}</span>points</h4>
                    <h4><span>${timeRemaining}</span>time remaining</h4>
                    <a onclick="getUserDetails()">Redeem Prize</a>
                </div>
            </div>
            `;
            $('#message_block').html(html);
            relocator(data.coordinates, data.slug);

        } else if(data.was_endpoint && data.is_correct === false) {
            // last checkpoint down the wrong path
            add_points(data.points);
            relocator(data.coordinates, data.slug);
            let points = localStorage.getItem('points');
            let treasure_id = localStorage.getItem('treasure_id');
            $('#message_block').removeClass();
            $('#message_block').addClass("content_block-three failure block_content");

            let html = `
            <div class="icon icon_1"></div>
            <div class="icon icon_2"></div>
            <div class="icon icon_3"></div>
            <div class="icon icon_4"></div>
            <div class="wrapper">
                <div class="pod">
                    <h2>FAILED</h2>
                    <h3>Seems you got lost</h3>
                    <h4><span>${points}</span>points</h4>
                    <a href="/hunt/${treasure_id}">Start the hunt again</a>
                </div>
            </div>
            `;
            $('#message_block').html(html);
        } else {
            add_points(data.points);
            relocator(data.coordinates, data.slug);
        }

    });

}


const getUserDetails = () => {
    $('#form-score').show();
    $('#message_block').hide();
}


const stopGame = () => {
    // stop the game when the timer stops
    let points = localStorage.getItem('points');
    let treasure_id = localStorage.getItem('treasure_id');
    $('#message_block').removeClass();
    $('#message_block').addClass("content_block-three failure block_content");

    let html = `
    <div class="icon icon_1"></div>
    <div class="icon icon_2"></div>
    <div class="icon icon_3"></div>
    <div class="icon icon_4"></div>
    <div class="wrapper">
        <div class="pod">
            <h2>TIMEâ€™S UP</h2>
            <h3>Sorry your time run out</h3>
            <h4><span>00:00:00</span></h4>
            <h4><span>${points}</span>points</h4>
            <a href="/hunt/${treasure_id}">Start the hunt again</a>
        </div>
    </div>
    `;
    $('#message_block').html(html);
}


function relocator(coordinates, slug) {
    let newPos = coordinates.split(',');
    let lat = newPos[0];
    let lng = newPos[1];
    const newPosition = new google.maps.LatLng({lat: Number(lat), lng: Number(lng)});
    get_next_clue(slug);
    panorama.setPosition(newPosition);
}


const get_next_clue = slug => {
    let treasure_id = localStorage.getItem('treasure_id');
    let endpoint = '/clue/options/' + treasure_id + '/' + slug;
    let clue_no = localStorage.getItem('clue');
    $.get( endpoint,  (data) => {
        let next_clue = parseInt(clue_no) + 1;
        localStorage.setItem('clue', next_clue);
         let html = `
            <div class="icon icon_1"></div>
            <div class="icon icon_2"></div>
            <div class="icon icon_3"></div>
            <div class="icon icon_4"></div>
            <div class="wrapper">
                <div class="pod">
                    <h2>CLUE #${next_clue}</h2>
                     <h3>${data.description}</h3>`;
                     $.each(data['options'], function(key, item) {
                         html += `<a onclick="relocatePlayer('${item['id']}')">${item['name']}</a>`;
                     });
            html += `
                </div>
            </div>
        `;
        $('#message_block').html(html);
    });
}


const add_points = (points) => {
    let current_points = localStorage.getItem('points');
    let total = parseInt(current_points) + parseInt(points);
    localStorage.setItem('points', total);
    $('#points').html(total); // update points
    return total;
}

</script>

{% endblock %}